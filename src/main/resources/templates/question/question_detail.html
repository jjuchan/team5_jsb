<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>질문 상세보기</title>
</head>
<body>
<!-- 질문 상세 정보 -->
<div>
    <h2 th:text="${question.subject}">제목</h2>
    <div>
        <span>작성자: </span>
        <span th:text="${question.author != null ? question.author.username : '알 수 없음'}"></span>
        <span> | </span>
        <span>작성일: </span>
        <span th:text="${#temporals.format(question.createDate, 'yyyy-MM-dd HH:mm')}"></span>
        <span> | </span>
        <span>조회수: </span>
        <span th:text="${question.viewCount}"></span>
    </div>
    <hr>
    <div th:utext="${question.content}">내용</div>
</div>

<!-- 버튼 영역 -->
<div>
    <a th:href="@{/question/list(page=${param.page ?: 0}, kw=${param.kw})}">목록</a>
    <th:block th:if="${#authorization.expression('isAuthenticated()') && #authentication.principal.username == question.author.username}">
        <a th:href="@{/question/modify/{id}(id=${question.id}, page=${param.page}, kw=${param.kw})}">수정</a>
        <a th:href="@{/question/delete/{id}(id=${question.id})}" onclick="return confirm('정말 삭제하시겠습니까?');">삭제</a>
    </th:block>
</div>

<!-- 답변 목록 -->
<div>
    <h3>답변 목록</h3>
    <div th:if="${!answerList.empty}">
        <div th:each="answer : ${answerList}">
            <div>
                <span th:text="${answer.author != null ? answer.author.username : '알 수 없음'}"></span>
                <span> | </span>
                <span th:text="${#temporals.format(answer.createDate, 'yyyy-MM-dd HH:mm')}"></span>
                <th:block th:if="${#authorization.expression('isAuthenticated()')}">
                    <a th:if="${#authentication.principal.username == answer.author.username}"
                       th:href="@{/answer/modify/{id}(id=${answer.id}, page=${param.page}, kw=${param.kw})}">수정</a>
                    <a th:if="${#authentication.principal.username == answer.author.username}"
                       th:href="@{/answer/delete/{id}(id=${answer.id}, page=${param.page}, kw=${param.kw})}"
                       onclick="return confirm('정말 삭제하시겠습니까?');">삭제</a>
                </th:block>
            </div>
            <div th:utext="${answer.content}"></div>
            <hr>
        </div>
    </div>
    <div th:if="${answerList.empty}">
        <p>등록된 답변이 없습니다.</p>
    </div>
</div>

<!-- 답변 페이징 -->
<div th:if="${answerList.totalPages > 1}">
    <div th:with="
            start = ${T(java.lang.Math).max(1, answerList.number - 2)},
            end = ${T(java.lang.Math).min(answerList.totalPages, answerList.number + 2)}">

        <!-- 첫 페이지로 이동 -->
        <span th:if="${!answerList.first}">
                <a th:href="@{/question/{id}(id=${question.id}, page=0, answerPage=0, kw=${param.kw})}">««</a>
            </span>

        <!-- 이전 페이지로 이동 -->
        <span th:if="${!answerList.first}">
                <a th:href="@{/question/{id}(id=${question.id}, page=${param.page}, answerPage=${answerList.number - 1}, kw=${param.kw})}">«</a>
            </span>

        <!-- 페이지 번호들 -->
        <span th:each="page: ${#numbers.sequence(start, end)}">
                <a th:if="${page == answerList.number + 1}"
                   th:text="${page}"
                   style="font-weight: bold"></a>
                <a th:unless="${page == answerList.number + 1}"
                   th:href="@{/question/{id}(id=${question.id}, page=${param.page}, answerPage=${page - 1}, kw=${param.kw})}"
                   th:text="${page}"></a>
            </span>

        <!-- 다음 페이지로 이동 -->
        <span th:if="${!answerList.last}">
                <a th:href="@{/question/{id}(id=${question.id}, page=${param.page}, answerPage=${answerList.number + 1}, kw=${param.kw})}">»</a>
            </span>

        <!-- 마지막 페이지로 이동 -->
        <span th:if="${!answerList.last}">
                <a th:href="@{/question/{id}(id=${question.id}, page=${param.page}, answerPage=${answerList.totalPages - 1}, kw=${param.kw})}">»»</a>
            </span>
    </div>
</div>

<!-- 답변 작성 폼 -->
<div th:if="${#authorization.expression('isAuthenticated()')}">
    <form th:action="@{/answer/create}" method="post">
        <input type="hidden" name="questionId" th:value="${question.id}">
        <input type="hidden" name="page" th:value="${param.page}">
        <input type="hidden" name="kw" th:value="${param.kw}">
        <div>
            <textarea name="content" rows="5" required></textarea>
        </div>
        <button type="submit">답변등록</button>
    </form>
</div>
</body>
</html>